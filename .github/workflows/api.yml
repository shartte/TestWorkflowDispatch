name: API Test

on:
  workflow_dispatch:

permissions:
  id-token: write
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Runs a single command using the runners shell
    - name: Get OIDC token
      id: oidc
      uses: actions/github-script@v7
      with:
        script: core.setOutput('token', await core.getIDToken('neoforge-meta-api'))
    - name: Print OIDC token claims
      run: |
        echo "### OIDC Token Claims" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        PAYLOAD=$(echo "${META_API_TOKEN}" | cut -d '.' -f 2)
        # Convert base64url to base64 and add padding
        PAYLOAD=$(echo "$PAYLOAD" | tr '_-' '/+')
        # Add padding if needed
        case $((${#PAYLOAD} % 4)) in
          2) PAYLOAD="${PAYLOAD}==" ;;
          3) PAYLOAD="${PAYLOAD}=" ;;
        esac
        echo "$PAYLOAD" | base64 -d | jq >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
      env:
        META_API_TOKEN: "${{ steps.oidc.outputs.token }}"
    - name: Query API
      run: |
        curl --fail -H "Authorization: Bearer ${META_API_TOKEN}" https://meta-api.prod.k8s.neoforged.net/v1/neoforged-versions/ -v -o response
        cat response | jq
      env:
        META_API_TOKEN: "${{ steps.oidc.outputs.token }}"
