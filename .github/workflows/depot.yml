name: Depot Upload Test

on:
  workflow_dispatch:

permissions:
  id-token: write
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Get OIDC token
      id: oidc
      uses: actions/github-script@v7
      with:
        script: core.setOutput('token', await core.getIDToken('https://depot-manager.neoforged.net'))
    - name: Print OIDC token claims
      run: |
        echo "### OIDC Token Claims" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        PAYLOAD=$(echo "${DEPOT_MANAGER_TOKEN}" | cut -d '.' -f 2)
        # Convert base64url to base64 and add padding
        PAYLOAD=$(echo "$PAYLOAD" | tr '_-' '/+')
        # Add padding if needed
        case $((${#PAYLOAD} % 4)) in
          2) PAYLOAD="${PAYLOAD}==" ;;
          3) PAYLOAD="${PAYLOAD}=" ;;
        esac
        echo "$PAYLOAD" | base64 -d | jq >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
      env:
        DEPOT_MANAGER_TOKEN: "${{ steps.oidc.outputs.token }}"
    - name: Query API
      run: |
        echo "Hello World!" > test.txt
        curl --fail -T test.txt -H "Authorization: Bearer ${DEPOT_MANAGER_TOKEN}" https://depot-manager.neoforged.net/test.txt
      env:
        DEPOT_MANAGER_TOKEN: "${{ steps.oidc.outputs.token }}"
